package gui_control.WirelessConnection;

import java.io.IOException;
import java.util.ArrayList;

import javax.bluetooth.BluetoothStateException;
import javax.bluetooth.DeviceClass;
import javax.bluetooth.DiscoveryAgent;
import javax.bluetooth.DiscoveryListener;
import javax.bluetooth.LocalDevice;
import javax.bluetooth.RemoteDevice;
import javax.bluetooth.ServiceRecord;

import gui_control.WirelessModel.WirelessConnectionModel;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;

public class WirelessConnection {
	ArrayList<RemoteDevice> remoteDevices;
	LocalDevice localDevice;
	ObservableList<WirelessConnectionModel> wirelessConnections = FXCollections.observableArrayList();
	
	final Object inquiryCompletedEvent = new Object();
	
	public WirelessConnection(){
		
	}
	
	public void searchForDevices() throws BluetoothStateException, InterruptedException{
		
	
	    DiscoveryListener listener = new DiscoveryListener(){
	
	        public void deviceDiscovered(RemoteDevice btDevice, DeviceClass cod) {
	            System.out.println("Device " + btDevice.getBluetoothAddress() + " found");
	            remoteDevices.add(btDevice);
	            wirelessConnections.add(new WirelessConnectionModel(btDevice.getBluetoothAddress(),""));
	            try {
	                System.out.println("     name " + btDevice.getFriendlyName(false));
	            } catch (IOException cantGetDeviceName) {
	            }
	        }
	
	        public void inquiryCompleted(int discType) {
	            System.out.println("Device Inquiry completed!");
	            synchronized(inquiryCompletedEvent){
	                inquiryCompletedEvent.notifyAll();
	            }
	        }

			@Override
			public void serviceSearchCompleted(int arg0, int arg1) {
				
			}

			@Override
			public void servicesDiscovered(int arg0, ServiceRecord[] arg1) {
				
			}
	
	    };
    
    
    	synchronized(inquiryCompletedEvent) {
	        boolean started = LocalDevice.getLocalDevice().getDiscoveryAgent().startInquiry(DiscoveryAgent.GIAC, listener);
	        if (started) {
	            System.out.println("wait for device inquiry to complete...");
	            inquiryCompletedEvent.wait();
	            if(remoteDevices!=null){
	            	System.out.println(remoteDevices.size() +  " device(s) found");
	            }
	            
	        }
	    }
    }




	/*public void searchForDevices() throws IOException{
		localDevice = LocalDevice.getLocalDevice();
		remoteDevices = localDevice.getDiscoveryAgent().retrieveDevices(DiscoveryAgent.PREKNOWN);
		
		/*for(RemoteDevice r: remoteDevices){
			System.out.println(r.getFriendlyName(false));
			System.out.println(r.getBluetoothAddress());
		}*/
	



	public ArrayList<RemoteDevice> getRemoteDevices() {
		return remoteDevices;
	}



	public void setRemoteDevices( ArrayList<RemoteDevice> remoteDevices) {
		this.remoteDevices = remoteDevices;
	}
	
	public ArrayList<WirelessConnectionModel> getWirelessConnectionModels() throws IOException{
		ArrayList<WirelessConnectionModel> result = new ArrayList<WirelessConnectionModel>();
		if(remoteDevices!=null){
			for(RemoteDevice r: remoteDevices){
				WirelessConnectionModel m = new WirelessConnectionModel(r.getFriendlyName(false),r.getBluetoothAddress());
				
				result.add(m);
			}	
		}
		
		result.add(new WirelessConnectionModel("hallo","hi"));
		
		return result;
	}



	public LocalDevice getLocalDevice() {
		return localDevice;
	}



	public void setLocalDevice(LocalDevice localDevice) {
		this.localDevice = localDevice;
	}
	
	
}
